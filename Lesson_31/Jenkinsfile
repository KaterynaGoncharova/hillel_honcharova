pipeline {
    agent any

    environment {
        // Встановлюємо шлях до файлу requirements.txt
        REQUIREMENTS_PATH = 'Lesson_31/requirements.txt'
    }

    stages {
        stage('Checkout') {
            steps {
                // Крок для вилучення коду з репозиторію
                git 'https://github.com/KaterynaGoncharova/hillel_honcharova'
            }
        }

        stage('Set up Python environment') {
            steps {
                script {
                    // Створення віртуального середовища
                    sh 'python3 -m venv venv'
                    // Встановлення залежностей з файлу requirements.txt
                    sh './venv/bin/pip install -r ${REQUIREMENTS_PATH}'
                }
            }
        }

        stage('Run tests') {
            steps {
                script {
                    // Запуск автотестів
                    sh './venv/bin/pytest'
                }
            }
        }

        stage('Publish test results') {
            steps {
                script {
                    // Публікація результатів тестування у Jenkins
                    junit '**/test-*.xml'
                }
            }
        }
    }

    post {
        always {
            // Надсилання електронних листів з результатами тестування
            mail to: 'InsertYour@Mail.Here',
                 subject: "Jenkins Build ${currentBuild.currentResult}: ${currentBuild.fullDisplayName}",
                 body: "Build URL: ${env.BUILD_URL}\n\n${currentBuild.fullDisplayName}\n\n${currentBuild.currentResult}"
        }
    }
}